name: Dart Main CI

on:
  push:
    branches:
      - main
    paths:
      - 'dart/**'
  workflow_dispatch:

jobs:
  test:
    uses: ./.github/workflows/dart-test.yml

  publish:
    name: Build and publish Dart package to pub.dev
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for version comparison

    - name: Check if version was updated
      id: version_check
      run: |
        # Check if pubspec.yaml was modified in this commit
        if git diff HEAD^ HEAD --name-only | grep -q "dart/pubspec.yaml"; then
          echo "Version file was modified"
          echo "version_changed=true" >> $GITHUB_OUTPUT
          
          # Extract version from pubspec.yaml
          VERSION=$(grep -m1 '^version: ' dart/pubspec.yaml | sed 's/version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"
        else
          echo "Version file was not modified"
          echo "version_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Dart
      if: steps.version_check.outputs.version_changed == 'true'
      uses: dart-lang/setup-dart@v1
      with:
        sdk: stable

    - name: Install dependencies
      if: steps.version_check.outputs.version_changed == 'true'
      working-directory: ./dart
      run: dart pub get

    - name: Verify package
      if: steps.version_check.outputs.version_changed == 'true'
      working-directory: ./dart
      run: |
        dart pub publish --dry-run

    - name: Publish package to pub.dev
      if: steps.version_check.outputs.version_changed == 'true'
      working-directory: ./dart
      env:
        PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}
      run: |
        mkdir -p ~/.config/dart
        echo "$PUB_CREDENTIALS" > ~/.config/dart/pub-credentials.json
        dart pub publish --force

    - name: Create GitHub Release
      if: steps.version_check.outputs.version_changed == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: dart-v${{ steps.version_check.outputs.version }}
        name: Dart v${{ steps.version_check.outputs.version }}
        body: |
          ## Dart Package Release v${{ steps.version_check.outputs.version }}
          
          ### ğŸ“¦ å®‰è£…
          ```yaml
          dependencies:
            hachi64: ^${{ steps.version_check.outputs.version }}
          ```
          
          æˆ–ä½¿ç”¨ dart/flutter å‘½ä»¤ï¼š
          ```bash
          dart pub add hachi64
          # æˆ–
          flutter pub add hachi64
          ```
          
          ### ğŸ”— é“¾æ¥
          - [pub.dev Package](https://pub.dev/packages/hachi64/versions/${{ steps.version_check.outputs.version }})
          - [API æ–‡æ¡£](https://pub.dev/documentation/hachi64/${{ steps.version_check.outputs.version }}/)
          - [GitHub](https://github.com/${{ github.repository }}/tree/main/dart)
          
          ### ğŸ“‹ å˜æ›´
          æ­¤ç‰ˆæœ¬åŒ…å« Dart åŒ…çš„æ›´æ–°ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
