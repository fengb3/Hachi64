name: Python Main CI

on:
  push:
    branches:
      - main
    paths:
      - 'python/**'
  workflow_dispatch:

jobs:
  test:
    uses: ./.github/workflows/python-test.yml

  publish:
    name: Build and publish Python distributions to PyPI
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for version comparison

    - name: Check if version was updated
      id: version_check
      run: |
        # Check if setup.py was modified in this commit
        if git diff HEAD^ HEAD --name-only | grep -q "python/setup.py"; then
          echo "Version file was modified"
          echo "version_changed=true" >> $GITHUB_OUTPUT
          
          # Extract version from setup.py
          VERSION=$(grep -oP 'version="\K[^"]+' python/setup.py)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"
        else
          echo "Version file was not modified"
          echo "version_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Python
      if: steps.version_check.outputs.version_changed == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      if: steps.version_check.outputs.version_changed == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        
    - name: Build package
      if: steps.version_check.outputs.version_changed == 'true'
      working-directory: ./python
      run: python -m build

    - name: Publish package to PyPI
      if: steps.version_check.outputs.version_changed == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages-dir: python/dist/

    - name: Create GitHub Release
      if: steps.version_check.outputs.version_changed == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: python-v${{ steps.version_check.outputs.version }}
        name: Python v${{ steps.version_check.outputs.version }}
        body: |
          ## Python Package Release v${{ steps.version_check.outputs.version }}
          
          ### ðŸ“¦ Installation
          ```bash
          pip install hachi64==${{ steps.version_check.outputs.version }}
          ```
          
          ### ðŸ”— Links
          - [PyPI Package](https://pypi.org/project/hachi64/${{ steps.version_check.outputs.version }}/)
          - [Documentation](https://github.com/${{ github.repository }}/tree/main/python)
          
          ### ðŸ“‹ Changes
          This release includes updates to the Python package.
        files: |
          python/dist/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}